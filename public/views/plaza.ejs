<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>CampusRun</title>
    <link rel="shortcut icon" href="TemplateDataPlaza/favicon.ico" />
    <link rel="stylesheet" href="TemplateDataPlaza/style.css" />
    <link rel="stylesheet" href="TemplateDataPlaza/progressbar.css" />
    <link rel="stylesheet" href="TemplateDataPlaza/plaza_style.css" />
    <link rel="stylesheet" href="../static/css/chat.css" />
    <script src="TemplateDataPlaza/UnityProgress.js"></script>
    <script src="BuildPlaza/UnityLoader1.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="client.js"></script>
    <script>
      var unityInstance = UnityLoader.instantiate(
        "unityContainer",
        "BuildPlaza/[Capstone]_webgl_test.json",
        { onProgress: UnityProgress }
      );
    </script>
  </head>
  <body>
    <div class="app__wrap" style="float:right">
      <div id="info" class="app__info"></div>
      <div id="chatWindow" class="app__window"></div>
      <div class="app__input__wrap">
        <input
          id="chatInput"
          type="text"
          class="app__input"
          autofocus
          placeholder="대화를 입력해주세요."
        />
        <button id="chatMessageSendBtn" class="app__button">전송</button>
      </div>
    </div>
    <div class="progresscontent">
      <div class="progressbar">
        <div class="color"></div>
      </div>
    </div>
    <div class="webgl-content">
      <div id="unityContainer" style="width: 960px; height: 600px"></div>
      <div class="footer">
        <div class="fullscreen" onclick="unityInstance.SetFullscreen(1)"></div>
      </div>
    </div>
    <button class="start-btn" id="btn_id" onclick="emitJoin()">
      GO TO PLAZA
    </button>

    <script src="../static/js/chat.js"></script>
  </body>
  <script>
    function emitJoin() {
      socket.emit(
        "LOGIN",
        JSON.stringify({
          name: `<%= userName %>`,
          position: "3.3:2.633828:0",
          avatar: "1"
        })
      );
      document.getElementById("btn_id").style.display = "none";
    }
  </script>
  <script>
    var chatWindow = document.getElementById("chatWindow");
    var sendButton = document.getElementById("chatMessageSendBtn");
    var chatInput = document.getElementById("chatInput");

    socket.on("connect", function() {
      socket.emit("newUserConnect", `<%= userName %>`);
    });

    socket.on("updateMessage", function(data) {
      if (data.name === "SERVER") {
        var info = document.getElementById("info");
        info.innerHTML = data.message;

        setTimeout(() => {
          info.innerText = "";
        }, 1000);
      } else {
        var chatMessageEl = drawChatMessage(data);
        chatWindow.appendChild(chatMessageEl);

        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
    });

    sendButton.addEventListener("click", function() {
      var message = chatInput.value;

      if (!message) return false;

      socket.emit("sendMessage", {
        message
      });

      chatInput.value = "";
    });

    function drawChatMessage(data) {
      var wrap = document.createElement("p");
      var message = document.createElement("span");
      var name = document.createElement("span");

      name.innerText = data.name;
      message.innerText = data.message;

      name.classList.add("output__user__name");
      message.classList.add("output__user__message");

      wrap.classList.add("output__user");
      wrap.dataset.id = socket.id;

      wrap.appendChild(name);
      wrap.appendChild(message);

      return wrap;
    }
  </script>
</html>
